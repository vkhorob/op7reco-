name: TWRP Recovery Build

on:
  workflow_dispatch:
    inputs:
      MANIFEST_URL:
        description: 'Manifest URL'
        required: true
        default: 'https://github.com/crdroidandroid/android.git'
      MANIFEST_BRANCH:
        description: 'Manifest Branch'
        required: true
        default: '15.0'
      DEVICE_TREE_URL:
        description: 'Device Tree URL'
        required: true
        default: 'https://github.com/crdroidandroid/android_device_oneplus_guacamoleb.git'
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch'
        required: true
        default: '15.0'
      DEVICE_PATH:
        description: 'Device Path'
        required: true
        default: 'device/oneplus/guacamoleb'
      DEVICE_NAME:
        description: 'Device Name'
        required: true
        default: 'guacamoleb'
      MAKEFILE_NAME:
        description: 'Makefile Name'
        required: true
        default: 'twrp_guacamoleb'
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recoveryimage'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean workspace
        run: |
          echo "Cleaning workspace..."
          sudo rm -rf $GITHUB_WORKSPACE/workspace || true
          mkdir -p $GITHUB_WORKSPACE/workspace

      - name: Initialize workspace
        id: workspace
        run: |
          cd workspace
          echo "folder=$(pwd)" >> $GITHUB_OUTPUT

      - name: Install build dependencies
        run: |
          sudo apt-get update -y
          DEBIAN_FRONTEND=noninteractive sudo apt-get install -y \
            git-core gnupg flex bison build-essential zip curl zlib1g-dev \
            gcc-multilib g++-multilib libc6-dev-i386 libncurses5-dev \
            x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev \
            libxml2-utils xsltproc unzip fontconfig python3 python3-pip \
            openjdk-11-jdk openjdk-17-jdk bc ccache liblz4-tool lzop \
            schedtool aria2 tar rsync jq repo libssl-dev libffi-dev
          
          sudo ln -sf /usr/bin/python3 /usr/bin/python

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Clean previous sources
        run: |
          cd $GITHUB_WORKSPACE/workspace
          rm -rf crdroid_android_15 fox_15.0 fox_twrp-12.1

      - name: Sync crDroid Android 15 sources
        run: |
          cd $GITHUB_WORKSPACE/workspace
          mkdir -p crdroid_android_15
          cd crdroid_android_15
          
          echo "Initializing crDroid Android 15..."
          repo init -u https://github.com/crdroidandroid/android.git -b 15.0 --depth=1
          
          echo "Syncing sources..."
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
          
          echo "✅ crDroid Android 15 synced successfully!"
        timeout-minutes: 60

      - name: Clone device tree
        run: |
          cd $GITHUB_WORKSPACE/workspace/crdroid_android_15
          echo "Cloning device tree..."
          rm -rf device/oneplus/guacamoleb
          git clone https://github.com/crdroidandroid/android_device_oneplus_guacamoleb.git -b 15.0 device/oneplus/guacamoleb
          echo "✅ Device tree cloned!"

      - name: Add TWRP recovery
        run: |
          cd $GITHUB_WORKSPACE/workspace/crdroid_android_15
          echo "Adding TWRP recovery..."
          
          mkdir -p .repo/local_manifests
          cat > .repo/local_manifests/twrp.xml << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<manifest>
  <remote name="github" fetch="https://github.com/" />
  <project path="bootable/recovery" name="TeamWin/android_bootable_recovery" remote="github" revision="android-15.0" />
</manifest>
EOF
          
          repo sync -c -j$(nproc --all) bootable/recovery --force-sync
          echo "✅ TWRP recovery added!"

      - name: Setup swap space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 16

      - name: Build TWRP recovery
        run: |
          cd $GITHUB_WORKSPACE/workspace/crdroid_android_15
          
          source build/envsetup.sh
          export ALLOW_MISSING_DEPENDENCIES=true
          export LC_ALL=C
          export USE_CCACHE=1
          ccache -M 50G
          
          lunch twrp_guacamoleb-eng
          make clean
          make recoveryimage -j$(nproc --all)
          
          echo "✅ Build completed!"

      - name: Upload recovery
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          files: $GITHUB_WORKSPACE/workspace/crdroid_android_15/out/target/product/guacamoleb/recovery.img
          name: TWRP-guacamoleb-Android15
          tag_name: twrp-$(date +%Y%m%d-%H%M%S)
          body: "TWRP Recovery for OnePlus 7 (Android 15)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
