name: TWRP Recovery Build

on:
  workflow_dispatch:
    inputs:
      MANIFEST_URL:
        description: 'Manifest URL'
        required: true
        default: 'https://github.com/crdroidandroid/android.git'
      MANIFEST_BRANCH:
        description: 'Manifest Branch'
        required: true
        default: '15.0'
      DEVICE_TREE_URL:
        description: 'Device Tree URL'
        required: true
        default: 'https://github.com/crdroidandroid/android_device_oneplus_guacamoleb.git'
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch'
        required: true
        default: '15.0'
      DEVICE_PATH:
        description: 'Device Path'
        required: true
        default: 'device/oneplus/guacamoleb'
      DEVICE_NAME:
        description: 'Device Name'
        required: true
        default: 'guacamoleb'
      MAKEFILE_NAME:
        description: 'Makefile Name'
        required: true
        default: 'twrp_guacamoleb'
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recoveryimage'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cleanup workspace
        run: |
          echo "Cleaning workspace..."
          sudo rm -rf $GITHUB_WORKSPACE/workspace || true

      - name: Initialize workspace
        id: workspace
        run: |
          mkdir -p workspace
          cd workspace
          echo "folder=$(pwd)" >> $GITHUB_OUTPUT

      - name: Install build dependencies
        run: |
          sudo apt-get update -y
          DEBIAN_FRONTEND=noninteractive sudo apt-get install -y \
            git-core gnupg flex bison build-essential zip curl zlib1g-dev \
            gcc-multilib g++-multilib libc6-dev-i386 libncurses5-dev \
            x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev \
            libxml2-utils xsltproc unzip fontconfig python3 python3-pip \
            openjdk-11-jdk openjdk-17-jdk bc ccache liblz4-tool lzop \
            schedtool aria2 tar rsync jq repo libssl-dev libffi-dev
          
          sudo ln -sf /usr/bin/python3 /usr/bin/python
        working-directory: ${{ steps.workspace.outputs.folder }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global color.ui false

      - name: Clean previous sources
        run: |
          cd ${{ steps.workspace.outputs.folder }}
          rm -rf crdroid_android_15
        working-directory: ${{ steps.workspace.outputs.folder }}

      - name: Sync crDroid Android 15 sources
        run: |
          cd ${{ steps.workspace.outputs.folder }}
          mkdir -p crdroid_android_15
          cd crdroid_android_15
          
          echo "Initializing crDroid Android 15 repository..."
          repo init -u ${{ github.event.inputs.MANIFEST_URL }} -b ${{ github.event.inputs.MANIFEST_BRANCH }} --depth=1
          
          echo "Syncing crDroid sources..."
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags --current-branch
          
          echo "crDroid Android 15 sources synced successfully!"
        timeout-minutes: 60

      - name: Clone device tree
        run: |
          cd ${{ steps.workspace.outputs.folder }}/crdroid_android_15
          echo "Cloning device tree for ${{ github.event.inputs.DEVICE_NAME }}..."
          rm -rf ./${{ github.event.inputs.DEVICE_PATH }}
          git clone ${{ github.event.inputs.DEVICE_TREE_URL }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} ./${{ github.event.inputs.DEVICE_PATH }}
          echo "Device tree cloned successfully!"

      - name: Add TWRP recovery source
        run: |
          cd ${{ steps.workspace.outputs.folder }}/crdroid_android_15
          echo "Adding TWRP recovery components..."
          
          mkdir -p .repo/local_manifests
          cat > .repo/local_manifests/twrp.xml << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<manifest>
  <remote name="github" fetch="https://github.com/" />
  <project path="bootable/recovery" name="TeamWin/android_bootable_recovery" remote="github" revision="android-15.0" />
</manifest>
EOF
          
          repo sync -c -j$(nproc --all) bootable/recovery --force-sync --no-clone-bundle
          echo "TWRP recovery components added!"

      - name: Setup swap space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 16

      - name: Build TWRP recovery
        run: |
          cd ${{ steps.workspace.outputs.folder }}/crdroid_android_15
          
          echo "Setting up build environment..."
          source build/envsetup.sh
          
          echo "Configuring build for ${{ github.event.inputs.DEVICE_NAME }}..."
          export ALLOW_MISSING_DEPENDENCIES=true
          export LC_ALL=C
          export USE_CCACHE=1
          ccache -M 50G
          
          echo "Lunching target: ${{ github.event.inputs.MAKEFILE_NAME }}-eng"
          lunch ${{ github.event.inputs.MAKEFILE_NAME }}-eng
          
          echo "Building TWRP recovery..."
          make clean
          make ${{ github.event.inputs.BUILD_TARGET }} -j$(nproc --all)
          
          echo "Build completed!"

      - name: Check build artifacts
        run: |
          cd ${{ steps.workspace.outputs.folder }}/crdroid_android_15
          echo "Checking for build artifacts..."
          find out/target/product/${{ github.event.inputs.DEVICE_NAME }}/ -name "*.img" -o -name "*.zip" | while read file; do
            echo "âœ“ Found: $file ($(du -h "$file" | cut -f1))"
          done

      - name: Upload recovery to release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.workspace.outputs.folder }}/crdroid_android_15/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/recovery.img
            ${{ steps.workspace.outputs.folder }}/crdroid_android_15/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.zip
          name: TWRP-${{ github.event.inputs.DEVICE_NAME }}-Android15-${{ github.run_number }}
          tag_name: twrp-${{ github.event.inputs.DEVICE_NAME }}-${{ github.run_number }}
          body: |
            ðŸš€ TWRP Recovery for ${{ github.event.inputs.DEVICE_NAME }}
            
            **Build Details:**
            - Android Version: 15.0
            - Source: crDroid
            - Device: ${{ github.event.inputs.DEVICE_NAME }}
            - Build Target: ${{ github.event.inputs.BUILD_TARGET }}
            
            **Sources:**
            - Manifest: ${{ github.event.inputs.MANIFEST_URL }}
            - Device Tree: ${{ github.event.inputs.DEVICE_TREE_URL }}
            
            Built automatically via GitHub Actions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.event.inputs.DEVICE_NAME }}-${{ github.run_number }}
          path: ${{ steps.workspace.outputs.folder }}/crdroid_android_15/build.log
          retention-days: 7
