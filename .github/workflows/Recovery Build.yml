name: TWRP Recovery Build

on:
  workflow_dispatch:
    inputs:
      MANIFEST_URL:
        description: 'Manifest URL'
        required: true
        default: 'https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git'
      MANIFEST_BRANCH:
        description: 'Manifest Branch'
        required: true
        default: 'twrp-12.1'
      DEVICE_TREE_URL:
        description: 'Device Tree URL'
        required: true
        default: 'https://github.com/TeamWin/android_device_oneplus_guacamole.git'
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch'
        required: true
        default: 'twrp-12.1'
      DEVICE_PATH:
        description: 'Device Path'
        required: true
        default: 'device/oneplus/guacamole'
      DEVICE_NAME:
        description: 'Device Name'
        required: true
        default: 'guacamole'
      MAKEFILE_NAME:
        description: 'Makefile Name'
        required: true
        default: 'twrp_guacamole'
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recoveryimage'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Nuclear cleanup
        run: |
          echo "üßπ CLEANING ALL LEFTOVER DIRECTORIES..."
          sudo rm -rf /home/runner/work/op7reco-/op7reco-/workspace/*
          sudo rm -rf /home/runner/work/op7reco-/op7reco-/.repo
          sudo rm -rf /home/runner/work/op7reco-/*/.* 2>/dev/null || true
          echo "‚úÖ Cleanup complete!"
          echo "üìä Remaining disk space:"
          df -h

      - name: Initialize workspace
        id: workspace
        run: |
          mkdir -p /home/runner/work/op7reco-/op7reco-/workspace
          cd /home/runner/work/op7reco-/op7reco-/workspace
          echo "folder=$(pwd)" >> $GITHUB_OUTPUT

      - name: Check disk space after cleanup
        run: |
          echo "üì¶ AVAILABLE DISK SPACE:"
          df -h
          echo "üóÇÔ∏è WORKSPACE CONTENTS:"
          ls -la /home/runner/work/op7reco-/op7reco-/workspace/ || echo "Workspace is clean"

      - name: Install build dependencies
        run: |
          sudo apt-get update -y
          DEBIAN_FRONTEND=noninteractive sudo apt-get install -y \
            git-core gnupg flex bison build-essential zip curl zlib1g-dev \
            gcc-multilib g++-multilib libc6-dev-i386 libncurses5-dev \
            x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev \
            libxml2-utils xsltproc unzip fontconfig python3 python3-pip \
            openjdk-11-jdk openjdk-17-jdk bc ccache liblz4-tool lzop \
            schedtool aria2 tar rsync jq repo libssl-dev libffi-dev
          
          sudo ln -sf /usr/bin/python3 /usr/bin/python

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global color.ui false

      - name: Sync TWRP sources
        run: |
          cd /home/runner/work/op7reco-/op7reco-/workspace
          mkdir -p twrp_build
          cd twrp_build
          
          echo "üîÑ INITIALIZING TWRP REPOSITORY..."
          repo init -u ${{ github.event.inputs.MANIFEST_URL }} -b ${{ github.event.inputs.MANIFEST_BRANCH }} --depth=1
          
          echo "üì• SYNCING TWRP SOURCES..."
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags --current-branch
          
          echo "‚úÖ TWRP SOURCES SYNCED SUCCESSFULLY!"
        timeout-minutes: 30

      - name: Clone device tree
        run: |
          cd /home/runner/work/op7reco-/op7reco-/workspace/twrp_build
          echo "üì± CLONING DEVICE TREE..."
          rm -rf ./${{ github.event.inputs.DEVICE_PATH }}
          git clone ${{ github.event.inputs.DEVICE_TREE_URL }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} ./${{ github.event.inputs.DEVICE_PATH }}
          echo "‚úÖ DEVICE TREE CLONED!"

      - name: Setup swap space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 12

      - name: Build TWRP recovery
        run: |
          cd /home/runner/work/op7reco-/op7reco-/workspace/twrp_build
          
          echo "‚öôÔ∏è SETTING UP BUILD ENVIRONMENT..."
          source build/envsetup.sh
          
          echo "üéØ CONFIGURING BUILD..."
          export ALLOW_MISSING_DEPENDENCIES=true
          export LC_ALL=C
          export USE_CCACHE=1
          ccache -M 20G
          
          echo "üçΩÔ∏è LUNCHING TARGET..."
          lunch ${{ github.event.inputs.MAKEFILE_NAME }}-eng
          
          echo "üèóÔ∏è BUILDING TWRP RECOVERY..."
          make clean
          make ${{ github.event.inputs.BUILD_TARGET }} -j$(nproc --all)
          
          echo "‚úÖ BUILD COMPLETED!"

      - name: Check build artifacts
        run: |
          cd /home/runner/work/op7reco-/op7reco-/workspace/twrp_build
          echo "üìã BUILD ARTIFACTS:"
          find out/target/product/${{ github.event.inputs.DEVICE_NAME }}/ -name "*.img" -o -name "*.zip" | while read file; do
            echo "‚úÖ FOUND: $file ($(du -h "$file" | cut -f1))"
          done || echo "‚ùå NO ARTIFACTS FOUND"

      - name: Upload recovery to release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          files: |
            /home/runner/work/op7reco-/op7reco-/workspace/twrp_build/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/recovery.img
            /home/runner/work/op7reco-/op7reco-/workspace/twrp_build/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.zip
          name: TWRP-${{ github.event.inputs.DEVICE_NAME }}-${{ github.run_number }}
          tag_name: twrp-${{ github.event.inputs.DEVICE_NAME }}-${{ github.run_number }}
          body: |
            üöÄ TWRP Recovery for ${{ github.event.inputs.DEVICE_NAME }}
            
            **Build Details:**
            - TWRP Version: 12.1
            - Device: ${{ github.event.inputs.DEVICE_NAME }}
            - Build Target: ${{ github.event.inputs.BUILD_TARGET }}
            
            Built automatically via GitHub Actions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.event.inputs.DEVICE_NAME }}-${{ github.run_number }}
          path: /home/runner/work/op7reco-/op7reco-/workspace/twrp_build/build.log
          retention-days: 3
