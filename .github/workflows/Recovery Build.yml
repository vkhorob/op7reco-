name: TWRP Recovery Build - CLEAN SLATE

on:
  workflow_dispatch

jobs:
  build:
    runs-on: windows-latest  # Windows has more space
    timeout-minutes: 240
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: üí• NUCLEAR CLEANSLATE - WIPE EVERYTHING
        run: |
          echo "üí• INITIATING NUCLEAR CLEANSLATE..."
          echo "üìä CURRENT DISK SPACE:"
          fsutil volume diskfree c:
          
          echo "üóëÔ∏è DELETING ALL GITHUB WORKSPACES..."
          Get-ChildItem "C:\Users\runneradmin\actions-runner\_work\" -Recurse -Force | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem "$env:GITHUB_WORKSPACE" -Recurse -Force | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem "C:\Users\runneradmin\.repo" -Recurse -Force | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          
          # Delete any fox_* directories anywhere
          Get-ChildItem "C:\" -Filter "fox_*" -Recurse -Directory -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          
          echo "üßπ CLEANING TEMP FILES..."
          Remove-Item -Path "C:\Users\runneradmin\AppData\Local\Temp\*" -Recurse -Force -ErrorAction SilentlyContinue
          
          echo "‚úÖ NUCLEAR CLEANUP COMPLETE!"
          echo "üìä DISK SPACE AFTER CLEANUP:"
          fsutil volume diskfree c:

      - name: üÜï CREATE FRESH WORKSPACE
        id: workspace
        run: |
          # Create completely fresh directory structure
          $FreshWorkspace = "C:\fresh_android_build_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
          New-Item -ItemType Directory -Path $FreshWorkspace -Force
          Set-Location $FreshWorkspace
          echo "folder=$FreshWorkspace" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          echo "üìÅ CREATED FRESH WORKSPACE: $FreshWorkspace"

      - name: üîß INSTALL MINIMAL DEPENDENCIES
        run: |
          echo "üì• INSTALLING ABSOLUTE MINIMUM DEPENDENCIES..."
          # Install only what we absolutely need
          choco install -y git python3 make --no-progress
          
          # Download repo tool manually
          curl -o repo.py https://storage.googleapis.com/git-repo-downloads/repo
          python repo.py --help

      - name: ‚òï SETUP JAVA
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ‚öôÔ∏è CONFIGURE GIT
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global color.ui false

      - name: üöÄ SYNC crDroid Android 15 - FRESH START
        run: |
          cd ${{ steps.workspace.outputs.folder }}
          echo "üîÑ SYNCING crDroid Android 15 ON CLEAN SLATE..."
          
          # Initialize in fresh directory
          python C:\repo.py init -u https://github.com/crdroidandroid/android.git -b 15.0 --depth=1
          
          echo "üì• STARTING FRESH SYNC..."
          python C:\repo.py sync -c -j2 --force-sync --no-clone-bundle --no-tags --current-branch
          
          echo "‚úÖ FRESH crDroid Android 15 SYNC COMPLETE!"

      - name: üì± CLONE DEVICE TREE
        run: |
          cd ${{ steps.workspace.outputs.folder }}
          echo "üì± CLONING FRESH DEVICE TREE..."
          git clone https://github.com/crdroidandroid/android_device_oneplus_guacamoleb.git -b 15.0 device/oneplus/guacamoleb
          echo "‚úÖ DEVICE TREE CLONED!"

      - name: üõ†Ô∏è ADD TWRP TO crDroid
        run: |
          cd ${{ steps.workspace.outputs.folder }}
          echo "üõ†Ô∏è ADDING TWRP TO crDroid BASE..."
          
          mkdir -p .repo/local_manifests
          @"
<?xml version="1.0" encoding="UTF-8"?>
<manifest>
  <remote name="github" fetch="https://github.com/" />
  <project path="bootable/recovery" name="TeamWin/android_bootable_recovery" remote="github" revision="android-15.0" />
</manifest>
"@ | Out-File -FilePath ".repo/local_manifests/twrp.xml" -Encoding UTF8
          
          python C:\repo.py sync -c -j2 bootable/recovery --force-sync --no-clone-bundle
          echo "‚úÖ TWRP ADDED TO crDroid!"

      - name: üèóÔ∏è BUILD TWRP FOR ANDROID 15
        run: |
          cd ${{ steps.workspace.outputs.folder }}
          
          echo "‚öôÔ∏è SETTING UP BUILD ENVIRONMENT..."
          . build/envsetup.ps1
          
          echo "üéØ CONFIGURING BUILD..."
          $env:ALLOW_MISSING_DEPENDENCIES = "true"
          $env:LC_ALL = "C"
          $env:USE_CCACHE = "1"
          
          echo "üçΩÔ∏è LUNCHING TARGET..."
          lunch twrp_guacamoleb-eng
          
          echo "üèóÔ∏è BUILDING TWRP FOR ANDROID 15..."
          make clean
          make recoveryimage -j2
          
          echo "‚úÖ TWRP FOR ANDROID 15 BUILD COMPLETE!"

      - name: üì¶ UPLOAD RECOVERY
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.workspace.outputs.folder }}/out/target/product/guacamoleb/recovery.img
          name: TWRP-Android15-Fresh-${{ github.run_number }}
          tag_name: twrp-android15-${{ github.run_number }}
          body: |
            üöÄ TWRP Recovery for Android 15
            ‚Ä¢ Built on clean slate
            ‚Ä¢ crDroid Android 15 base
            ‚Ä¢ Fresh workspace, no leftovers
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
