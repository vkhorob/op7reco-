name: TWRP Recovery Build

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'Manifest Branch'
        required: true
        default: 'twrp-12.1'
      DEVICE_TREE_URL:
        description: 'Device Tree URL'
        required: true
        default: 'https://github.com/TeamWin/android_device_oneplus_guacamole'
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch'
        required: true
        default: 'android-12.1'
      DEVICE_PATH:
        description: 'Device Path'
        required: true
        default: 'device/oneplus/guacamoleb'
      COMMON_TREE_URL:
        description: 'Common Tree URL (optional)'
        required: false
        default: ''
      COMMON_PATH:
        description: 'Common Path (optional)'
        required: false
        default: ''
      DEVICE_NAME:
        description: 'Device Codename'
        required: true
        default: 'guacamoleb'
      MAKEFILE_NAME:
        description: 'Makefile Name'
        required: true
        default: 'twrp_guacamoleb'
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recovery'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y git python3 curl unzip bc bison build-essential \
                              zip ccache libncurses5-dev libssl-dev liblz4-tool \
                              libxml2-utils libncurses-dev repo aria2

      - name: Configure Git
        run: |
          git config --global user.name "YourName"
          git config --global user.email "youremail@example.com"

      - name: Initialize workspace
        run: |
          mkdir workspace
          echo "workspace-folder=$(pwd)/workspace" >> $GITHUB_OUTPUT
        id: pwd

      - name: Initialize repo
        run: |
          cd ${{ steps.pwd.outputs.workspace-folder }}
          repo init --depth=1 -u https://github.com/TeamWin/android.git -b ${{ github.event.inputs.MANIFEST_BRANCH }}
          repo sync -j$(nproc --all)

      - name: Clone device tree
        run: |
          cd ${{ steps.pwd.outputs.workspace-folder }}
          git clone ${{ github.event.inputs.DEVICE_TREE_URL }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} ./${{ github.event.inputs.DEVICE_PATH }}

      - name: Clone common tree
        if: ${{ github.event.inputs.COMMON_TREE_URL != '' && github.event.inputs.COMMON_PATH != '' }}
        run: |
          cd ${{ steps.pwd.outputs.workspace-folder }}
          git clone ${{ github.event.inputs.COMMON_TREE_URL }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} ./${{ github.event.inputs.COMMON_PATH }}

      - name: Set Swap Space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 12

      - name: Install OpenJDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '8'

      - name: Build TWRP Recovery
        run: |
          cd ${{ steps.pwd.outputs.workspace-folder }}
          source build/envsetup.sh
          export ALLOW_MISSING_DEPENDENCIES=true
          lunch ${{ github.event.inputs.MAKEFILE_NAME }}-eng
          make clean
          make ${{ github.event.inputs.BUILD_TARGET }}image -j$(nproc --all)

      - name: Upload artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.pwd.outputs.workspace-folder }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.img
            ${{ steps.pwd.outputs.workspace-folder }}/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.zip
          name: ${{ github.event.inputs.DEVICE_NAME }}-${{ github.run_id }}
          tag_name: ${{ github.run_id }}
          body: |
            Manifest: ${{ github.event.inputs.MANIFEST_BRANCH }}
            Device: ${{ github.event.inputs.DEVICE_NAME }}
            Target: ${{ github.event.inputs.BUILD_TARGET }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
